---
title: "treeRchitecture_examples"
output: html_notebook
---

This notebook gives examples of operations on cylinder model of trees (QSMs)
It relies on the QSM format from Pasi Raumonen's TreeQSM
It is essentially a few summaries and plots from Allie Shenkin's treestruct 
+ a few functions from treeRchitecture_functions.R. I'm adding to this.

This section just sets up the packages
```{r}
#devtools::install_github("ashenkin/treestruct",force=TRUE)
#detach("package:treestruct", unload = TRUE)

library(treestruct)
library(rmatio)
library(testit)
library(R.matlab)
library(visNetwork)
library(tidyverse)
library(magrittr)
```

Load in the data and convert to treestructs following ashenkin github example
```{r}

TLS="C:/Users/tobyd/Documents/Data/TLS_Data/QSMs/test_qsm/"

my_trees = import_treestructs_from_dir(qsm_path = TLS, qsmver = "UCL", recursive = T)
my_qsms = TreeStructs(dataset = "my_trees", treestructs = my_trees)
my_qsms = run_all(my_qsms)  # run all architectural analyses
my_qsms = parse_id(my_qsms, treetag_regex = ".*(?=\\.mat)", nobranchcode = T)  # add tree tag to df

# Add plot and tree tag to the cyl data frame inside the list
for (i in seq(1,length(my_qsms$treestructs$treestruct))){
  #my_qsms$treestructs$treestruct[[i]]$tag =my_qsms$treestructs$tag[i]
  my_qsms$treestructs$treestruct[[i]]$tag=i
  my_qsms$treestructs$treestruct[[i]]$plot=my_qsms$treestructs$plot[i]
}

my_treestructs = getTreestructs(my_qsms)  # tree level summaries of current architectural variables

# You can safely ignore the warnings below
```


Add 'treeRchitecture_functions'
```{r}
# path to your R folder with these functions (also used to save figs)
treeRchitecture="C:/Users/tobyd/OneDrive - University Of Cambridge/R/treeRchitecture/"
source(paste0(treeRchitecture,'treeRchitecture_functions.R'))
```


Calculate verticlaly binned summaries of the tree structure
I'm using the treestructs (rather than cyl_summs) so there are more cylinders per bin
It should be generalisable to cyl_summs once all the same variables are included there

```{r}

my_qsms$treestructs$treestruct %<>% lapply(add_centres_and_height_bin,bin_size=5) 
# bin_size = vertical size of the bins in m

# get summaries per height bin
rad_per_height_bin=bind_rows(my_qsms$treestructs$treestruct) %>% 
  group_by(plot,tag,height_of_bin_m) %>% 
  summarize(max_rad=max(rad),median_rad=median(rad)) # Maximum radius 
summary(rad_per_height_bin$plot)

# plot it out
ggplot(rad_per_height_bin,aes(max_rad,height_of_bin_m,color=as.factor(tag)))+
  geom_line()+geom_point()+facet_wrap(~plot)+theme(legend.position = "none")
ggsave(filename=paste0(treeRchitecture,'Example_fig_max_radius_per_height_bin.png'),width=6,height=3)

```


Calculate branching angles
```{r}

my_qsms$treestructs$treestruct %<>% lapply(add_angles) # add angles to all trees in the list
# this produces some NaN's where there is no parent cylinder, don't worry about that

# Plot the distributions of branching angles for the trees
bind_rows(my_qsms$treestructs$treestruct) %>%
  filter(order_in_branch==1) %>%  # use only cyls after the bifurcation points to get the branching angles only.
  ggplot(aes(x=angle_from_parent_z,color=as.factor(tag)))+stat_density(alpha = 1,size = 0.5,geom="line", position = "identity")+facet_wrap(~plot)


branching_angle_per_height_bin=bind_rows(my_qsms$treestructs$treestruct) %>% 
  group_by(plot,tag,height_of_bin_m) %>% 
  filter(order_in_branch==1) %>% # select only the cyls after branching point to get branching angles
  summarize(mean_angle_z=mean(angle_from_parent_z,na.rm=TRUE),
            mean_angle_3d=mean(angle_from_parent_3d,na.rm=TRUE))  


ggplot(branching_angle_per_height_bin,aes(mean_angle_z,height_of_bin_m,color=as.factor(tag)))+geom_line()+geom_point()+facet_wrap(~plot)+theme(legend.position = "none")

ggsave(filename=paste0(treeRchitecture,'Example_fig_mean_branching_angle_per_height_bin.png'),width=6,height=3)



```
